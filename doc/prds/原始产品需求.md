好的，这是一个基于您想法整理的产品需求文档，重点关注了可实现性，并包含了 Mermaid 图以帮助开发团队理解。

## Git 增强工具产品需求文档

### 1. 引言

#### 1.1 项目概述
本项目旨在开发一款基于 Rust 和 Clap 的 Git 扩展工具，通过集成人工智能（AI）和代码扫描功能，增强现有的 Git 命令行体验，提高开发效率和代码质量。

#### 1.2 项目目标
*   通过 `git-enhancer` 的 `--ai` 标志激活 AI 功能，实现：
    *   自动生成规范的 Git Commit Message。
    *   对用户指定的 Git 命令进行 AI 解释。
*   在 `git add` 阶段集成代码扫描能力，提前发现潜在问题。
*   优化提交流程，将代码扫描结果与 Commit 信息关联。
*   提供灵活的配置选项，并确保工具的易用性和可扩展性。

#### 1.3 目标用户
所有使用 Git 进行版本控制的开发者。

### 2. 功能需求

#### 2.1 AI 辅助 Git Commit

*   **需求描述**：用户在使用 `git-enhancer` 执行 Git Commit 相关操作时，可以通过添加 `--ai` 参数给 `git-enhancer`，让工具自动生成 Commit Message。
*   **实现逻辑**：
    1.  当用户执行 `git-enhancer --ai commit <other_git_commit_args>` 时，工具解析到自身的 `--ai` 标志以及 `commit` 子命令。
    2.  工具执行 `git diff --staged`（或类似命令）获取已暂存的代码变更内容。
    3.  将获取到的代码变更信息发送给配置好的人工智能服务（如 OpenAI API），并附带一个用于生成 commit message 的系统提示。
    4.  AI 服务根据代码变更生成符合规范的 Commit Message。
    5.  工具使用 AI 生成的 Message，并结合用户提供的 `<other_git_commit_args>`（如 `-S` 等），执行 `git commit -m "<generated_message>" <other_git_commit_args>`。
*   **相关配置**：AI 服务地址、API Key、模型选择、Commit Message 生成提示等（详见配置管理章节）。
*   **命令行示例**：
    *   `git-enhancer --ai commit`
    *   `git-enhancer --ai commit -S` (如果用户需要GPG签名)
    *   `git-enhancer --ai commit --amend` (用户提供的原始信息可以作为 AI 生成的补充或参考，或在 amend 场景下由 AI 基于现有 diff 生成新 message)

#### 2.2 Git Add 集成代码扫描

*   **需求描述**：用户在执行 `git add` 命令时，可以通过添加 `--scan` 参数，触发对本次改动代码的自动扫描。
*   **实现逻辑**：
    1.  当用户执行 `git add <files> --scan` 时，工具在执行标准的 `git add` 操作后，启动代码扫描流程。
    2.  工具将当前仓库的代码（或根据 `<files>` 确定扫描范围）打包压缩。
    3.  通过 HTTP POST 请求将压缩包发送到用户配置的代码扫描系统。
    4.  在本地（如项目根目录下的 `.git/.scan_info` 或用户指定位置）创建一个跟踪文件，记录以下信息：
        *   扫描任务 ID（如果扫描系统返回）。
        *   扫描状态（例如：`pending`, `in_progress`, `completed`, `failed`）。
        *   发起扫描的时间戳。
        *   关联的 Git Commit 哈希（初始为空，在 Commit 后更新）。
*   **相关配置**：代码扫描系统地址、认证方式、打包范围配置等。
*   **命令行示例**：`git add . --scan`

#### 2.3 Commit 流程与代码扫描结果联动

*   **需求描述**：用户执行 `git commit` 时，如果检测到存在由 `--scan` 触发且尚未完成或未关联到 Commit 的扫描任务，应提示用户并允许用户等待扫描结果。
*   **实现逻辑**：
    1.  当用户执行 `git commit`（无论是否带 `--ai` 参数）时，工具检查本地是否存在活动的扫描跟踪文件。
    2.  **如果存在活动的扫描任务**（例如状态为 `pending` 或 `in_progress`）：
        *   向用户提示：“检测到正在进行的代码扫描任务。是否等待扫描结果并将其信息包含在 Commit Message 中？(yes/no/details)”。
        *   如果用户选择 `yes`：工具将轮询代码扫描系统获取最新状态。获取成功后，可以将扫描结果摘要或链接提供给用户，或（如果使用 `--ai`）作为附加上下文信息提供给 AI 生成 Commit Message。
        *   如果用户选择 `no`：继续执行 Commit 流程，不等待扫描结果。
        *   如果用户选择 `details`：显示当前扫描任务的详细状态。
    3.  **如果扫描任务已完成但未关联 Commit**：
        *   提示用户可以将扫描结果（如问题摘要、通过状态）包含在 Commit Message 中。
    4.  Commit 成功后，更新扫描跟踪文件，将当前 Commit 的哈希值与对应的扫描任务关联起来。

#### 2.4 配置文件管理

*   **需求描述**：工具应支持通过配置文件进行个性化设置，并在首次使用时自动创建和配置。
*   **实现逻辑**：
    1.  **配置文件位置**：在代码仓库的根目录下，例如 `.git_enhancer_config.toml`。
    2.  **自动创建**：当工具首次在项目中执行或未找到配置文件时，自动创建一个包含默认设置的配置文件。
    3.  **.gitignore 集成**：首次创建配置文件时，自动将该配置文件名添加到项目的 `.gitignore` 文件中，以避免将本地配置（尤其是 API 密钥等敏感信息）提交到仓库。
    4.  **配置内容示例**：
        ```toml
        [ai]
        # AI 服务提供商，例如 "openai", "gemini" 等
        provider = "openai"
        api_key = "YOUR_OPENAI_API_KEY" # 提示用户填写
        model = "gpt-3.5-turbo"
        # 生成 commit message 的 prompt 模板等
        commit_message_prompt = "Generate a concise git commit message in conventional commit format for the following changes:"

        [code_scan]
        # 代码扫描系统地址
        endpoint = "https://your.codescan.server/api/scan"
        # 认证 Token 或其他凭证
        auth_token = "YOUR_SCAN_AUTH_TOKEN" # 提示用户填写
        # 扫描历史/跟踪文件路径，相对于 .git 目录
        tracking_file = ".scan_info"

        [history]
        # 用于记录扫描历史的定位点等，例如上次扫描的commit
        last_scanned_commit = ""
        ```
    5.  **配置加载**：工具启动时加载配置文件，优先使用项目级配置。未来可考虑支持用户级的全局配置。

#### 2.5 AI 驱动的 Git 命令解释

*   **需求描述**：用户在使用 `git-enhancer --ai` 时，如果其后跟随的 Git 命令中包含帮助标志（如 `--help` 或 `-h`），工具应调用 AI 对该 Git 命令进行解释，而不是执行该命令或显示其标准帮助文本。
*   **实现逻辑**：
    1.  `git-enhancer` 启动时解析到自身的 `--ai` 标志。
    2.  `git-enhancer` 进一步解析传递给它的参数，识别出目标 Git 命令及其参数（例如，`status --short --help`）。
    3.  检查目标 Git 命令的参数中是否包含 `--help` 或 `-h`。
    4.  如果 `git-enhancer` 的 `--ai` 标志存在，并且目标 Git 命令包含帮助标志，则工具捕获完整的 Git 命令字符串（例如 "status --short" 或 "branch -d old-feature"）。
    5.  将此 Git 命令字符串发送给配置的 AI 服务，并附带一个特定的系统提示，要求 AI 解释这个 Git 命令及其选项的用途和效果。
    6.  将 AI 服务返回的解释文本输出到用户的终端。
    7.  如果未使用 `--ai` 标志，或者 `--ai` 标志存在但目标 Git 命令不包含帮助标志，则 `git-enhancer` 正常传递命令给 Git 执行（例如 `git-enhancer commit -m "message"` 或 `git-enhancer --ai commit`）。
*   **相关配置**：AI 服务地址、API Key、模型选择、命令解释系统提示等。
*   **命令行示例**：
    *   `git-enhancer --ai status --short --help`
    *   `git-enhancer --ai branch -d old-feature --help`
    *   `git-enhancer --ai commit --amend --no-edit --help`

### 3. 技术选型与架构

#### 3.1 核心技术
*   **编程语言**：Rust。
*   **命令行参数解析**：Clap 库。

#### 3.2 架构设计
*   **模块化**：代码结构应清晰划分，例如分为命令行处理模块、Git 交互模块、AI 服务模块、代码扫描模块、配置管理模块。
*   **可扩展性**：设计时应考虑到未来功能的扩展，例如支持新的 AI 服务、新的代码扫描工具或新的 Git 子命令增强。Clap 允许通过组合不同的参数结构体来方便地扩展命令行接口。

### 4. 工作流程图 (Mermaid)

#### 4.1 AI 辅助 Commit (`git-enhancer --ai commit`) 流程

```mermaid
graph TD
    A[用户执行: git-enhancer --ai commit <args>] --> B{工具解析 --ai 和 commit 命令};
    B --> C[执行 'git diff --staged'];
    C --> D[捕获暂存区代码变更];
    D --> E[将变更信息和 Commit 提示发送至配置的 AI 服务];
    E --> F[AI 服务生成 Commit Message];
    F --> G[工具接收 Commit Message];
    G --> H[执行 'git commit -m "AI 生成的 Message" <args>'];
    H --> I[Commit 完成];
```

#### 4.2 代码扫描与 Commit 联动流程 (`git add --scan` 后接 `git commit`)

```mermaid
graph TD
    subgraph Git Add 阶段
        AA[用户执行: git add <files> --scan] --> AB{工具拦截命令};
        AB --> AC[执行 'git add <files>'];
        AC --> AD[打包仓库代码 (或指定文件)];
        AD --> AE[通过 POST 请求发送至代码扫描系统];
        AE --> AF[创建/更新本地扫描跟踪文件 (状态: pending, 扫描ID)];
    end

    subgraph Git Commit 阶段
        CA[用户执行: git commit] --> CB{工具拦截命令};
        CB --> CC{检查是否存在活动的扫描跟踪文件?};
        CC -- 是 --> CD{扫描任务进行中?};
        CD -- 是 --> CE[提示用户: 是否等待扫描结果?];
        CE -- 是 --> CF[轮询扫描系统获取状态/结果];
        CF -- 扫描完成 --> CG[获取扫描结果];
        CG --> CH[可选: 将扫描结果纳入 Commit Message (手动或通过AI)];
        CH --> CI[执行实际的 'git commit'];
        CD -- 否/已完成 --> CG;
        CE -- 否 --> CI;
        CC -- 否 --> CI;
        CI -- Commit 成功 --> CJ[更新扫描跟踪文件, 关联 Commit 哈希];
        CJ --> CK[Commit 完成];
    end
```

#### 4.3 AI 驱动的 Git 命令解释流程 (`git-enhancer --ai <git_command_with_help>`)

```mermaid
graph TD
    A[用户执行: git-enhancer --ai <git_command> --help] --> B{工具解析 --ai 标志};
    B --> C{解析 <git_command> 及其参数};
    C --> D{<git_command> 参数中是否包含 --help 或 -h?};
    D -- 是 --> E[捕获完整的 Git 命令 (不含 --help/-h, 用于解释)];
    E --> F[将 Git 命令和解释提示发送至 AI 服务];
    F --> G[AI 服务生成命令解释];
    G --> H[工具接收解释文本];
    H --> I[将解释输出到终端];
    I --> J[流程结束];
    D -- 否 --> K[按正常流程处理或传递给 Git];
    K --> J;
```

### 5. 非功能性需求

*   **性能**：工具的执行不应显著拖慢正常的 Git 操作。
*   **易用性**：清晰的命令行提示和错误信息。
*   **安全性**：妥善处理 API Key 等敏感信息，避免硬编码，并通过 `.gitignore` 防止泄露。
*   **兼容性**：尽可能兼容主流操作系统（Windows, macOS, Linux）。

### 6. 未来展望（本次迭代范围外）
*   支持更多的 AI 服务提供商。
*   集成多种代码扫描工具。
*   提供更丰富的扫描结果展示和交互。
*   通过 Git Hooks 实现更自动化的流程（例如 pre-commit 自动扫描）。
*   支持更细致的扫描范围配置。

希望这份产品需求文档能够帮助您清晰地规划和开发这款 Git 增强工具。
